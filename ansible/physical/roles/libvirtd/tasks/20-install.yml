---
- block:

    - name: Install libvirt and related tools
      pacman:
        name:
          - libguestfs
          - libvirt
          - openbsd-netcat  # libvirt management over ssh
          - ovmf
          - qemu  # libvirt backend
          - virt-install  # libvirt management via console (incl. virt-clone)
      notify: Set install reason for packages

    - name: Install qemu configuration file
      copy:
        src: qemu.conf
        dest: /etc/libvirt/qemu.conf
        mode: 0755
      notify: Restart libvirtd

    - name: Install units for libvirt and related tools
      copy:
        src: etc_systemd_system/
        dest: /etc/systemd/system/

    # There's no need to start and enable libvirt, as it's automatically started
    # when virt-manager connects. In addition, libvirtd automatically stops if
    # no clients are connectd and no domains are running for a while, and
    # starting it here means that ansible will produce tasks with a "changed"
    # state even on a correctly configured system.
    #
    # This task disables libvirtd.service because an earlier version of this
    # role enabled it.
    - name: Disable libvirtd
      systemd:
        name: libvirtd
        enabled: false
        daemon_reload: true  # due to /etc/systemd/system/ changes above

  become: true
